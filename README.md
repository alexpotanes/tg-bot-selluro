# Telegram Bot для приема заказов

Telegram бот для приема и обработки заказов с интеграцией в Google Sheets и платежной системой.

## Возможности

- ✅ Проверка подписки пользователя на Telegram каналы
- ✅ Прием заказов через Web App
- ✅ Валидация данных заказа
- ✅ Прием платежей через Telegram Payments (ЮKassa)
- ✅ Сохранение заказов в Google Sheets
- ✅ Безопасное хранение конфиденциальных данных

## Требования

- Node.js >= 16.0.0
- npm >= 7.0.0

## Установка

1. Установка зависимости:
```
npm install
```

2. Создайте и з аполните `.env` на основе `.env.example`:
```env
BOT_TOKEN="your_telegram_bot_token"
GOOGLE_PRIVATE_KEY="your_google_service_account_private_key"
PAYMENT_TOKEN="your_payment_provider_token"
CHANNEL_ID_1="your_first_channel_id"
CHANNEL_ID_2="your_second_channel_id"
```

## Используется

1. Ключ Google Sheets API
2. Платежная система ЮKassa
3. ID Telegram каналов с подпиской от Tribute

## Структура проекта

```
├── index.js                            # Точка входа приложения
├── src/                                # Исходный код
│   ├── config/                         # Конфигурация
│   │   ├── env.js                      # Переменные окружения и валидация
│   │   └── constants.js                # Константы приложения
│   ├── services/                       # Бизнес-логика
│   │   ├── priceCalculator.js          # Расчет цен
│   │   ├── paymentService.js           # Управление платежами
│   │   └── googleSheetsService.js      # Интеграция с Google Sheets
│   ├── middleware/                     # Промежуточные обработчики
│   │   ├── rateLimiter.js              # Защита от злоупотреблений
│   │   └── subscriptionChecker.js      # Проверка подписки
│   ├── handlers/                       # Обработчики событий бота
│   │   ├── startHandler.js             # Команда /start
│   │   ├── webAppDataHandler.js        # Данные Web App
│   │   ├── callbackQueryHandler.js     # Кнопки
│   │   ├── preCheckoutHandler.js       # Валидация платежа
│   │   └── successfulPaymentHandler.js # Успешный платеж
│   └── validators/                     # Валидация данных
│       └── orderValidator.js           # Валидация заказов
├── tests/                              # Тесты
│   ├── orderValidator.test.js          # Тесты валидации
│   ├── priceCalculator.test.js         # Тесты расчета цен
│   └── rateLimiter.test.js             # Тесты лимитов
├── buttons.js                          # Кнопки интерфейса
├── descriptions.js                     # Текстовые сообщения
├── keys.js                             # Ключи Google Sheets
├── .env                                # Переменные окружения
├── .env.example                        # Пример конфигурации
├── jest.config.js                      # Конфигурация Jest
├── package.json                        # Зависимости проекта
└── README.md                           # Данный файл
```

## Архитектура

Проект использует модульную архитектуру с разделением ответственности:

### Слои приложения

1. **Точка входа** (`index.js`)
   - Инициализация бота
   - Регистрация обработчиков событий
   - Запуск сервисов

2. **Конфигурация** (`src/config/`)
   - Валидация переменных окружения
   - Константы приложения
   - Правила валидации

3. **Сервисы** (`src/services/`)
   - Бизнес-логика
   - Интеграция с внешними API
   - Управление состоянием

4. **Middleware** (`src/middleware/`)
   - Защита от злоупотреблений
   - Проверка подписок
   - Валидация запросов

5. **Обработчики** (`src/handlers/`)
   - Обработка команд бота
   - Обработка callback query
   - Обработка платежей

6. **Валидаторы** (`src/validators/`)
   - Валидация входных данных
   - Проверка бизнес-правил

## Запуск

### Разработка
```
npm run dev
```

### Продакшн
Рекомендуется использовать PM2:

```bash
npm install -g pm2
pm2 start index.js --name tg-bot
pm2 save
pm2 startup
```

## Использование

### Пользовательский сценарий

1. Пользователь отправляет `/start` боту
2. Бот проверяет подписку на каналы
3. Если пользователь подписан - показывает кнопку для заполнения заказа
4. Пользователь заполняет Web App форму с деталями заказа
5. Бот получает данные, валидирует их и создает счет на оплату
6. После успешной оплаты данные сохраняются в Google Sheets

### Валидация данных

Бот проверяет:
- Количество артикулов: 1-1000
- Количество фото: 0-1000
- Корректность email адреса
- Соответствие суммы платежа

### Rate Limiting

Защита от злоупотреблений:
- Максимум 5 запросов за 10 секунд на пользователя
- Автоматическое уведомление при превышении лимита

## Тестирование

Проект покрыт юнит-тестами для критического функционала.

### Запуск тестов

```bash
# Запуск всех тестов
npm test

# Запуск тестов в watch mode
npm run test:watch

# Запуск тестов с покрытием
npm run test:coverage
```

### Тестовое покрытие

Тесты покрывают:
- ✅ Валидация данных заказа (16 тестов)
- ✅ Расчет цен и конвертация валют (20 тестов)
- ✅ Проверка злоупотреблений (12 тестов)

**Всего: 49 тестов**

### Структура тестов

```
tests/
├── orderValidator.test.js       # Валидация заказов
├── priceCalculator.test.js      # Расчет цен
└── rateLimiter.test.js          # Проверка злоупотреблений
```

### Примеры тестовых сценариев

**Валидация:**
- Валидные и невалидные данные заказа
- Граничные значения
- Проверка email формата
- Множественные ошибки

**Расчет цен:**
- Стандартные заказы
- Граничные случаи
- Конвертация рублей/копеек
- Обработка ошибок

**Проверка злоупотреблений:**
- Превышение лимита
- Изоляция между пользователями
- Истечение времени окна
- Cleanup устаревших записей

## Обновление

Для обновления зависимостей:
```
npm update
npm audit
```
